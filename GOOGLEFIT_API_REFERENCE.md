# Google Fit Integration API Documentation\n\n## Overview\n\nThe Health Monitor app includes a complete Google Fit integration API that allows secure synchronization of health data from Google Fit.\n\n---\n\n## Authentication\n\n### OAuth 2.0 Flow\n\nThe app uses **OAuth 2.0** for secure authentication. Users don't give their password to the app - instead, Google verifies their identity.\n\n```\nUser → App → Google → User (login) → Google → App → User\n```\n\n### Scopes Required\n\n```\nhttps://www.googleapis.com/auth/fitness.activity.read\nhttps://www.googleapis.com/auth/fitness.sleep.read\nhttps://www.googleapis.com/auth/fitness.nutrition.read\n```\n\n---\n\n## Endpoints\n\n### 1. Get Authorization URL\n\n**Endpoint**: `GET /api/google-fit/auth-url`\n\n**Purpose**: Get the OAuth authorization URL to send user to Google\n\n**Request**:\n```bash\ncurl http://localhost:5000/api/google-fit/auth-url\n```\n\n**Response** (Success):\n```json\n{\n  \"success\": true,\n  \"authUrl\": \"https://accounts.google.com/o/oauth2/v2/auth?client_id=...\",\n  \"message\": \"Redirect user to this URL to authorize Google Fit access\"\n}\n```\n\n**Response** (Error):\n```json\n{\n  \"success\": false,\n  \"error\": \"Failed to generate authorization URL\"\n}\n```\n\n**Usage**:\n```javascript\nconst response = await fetch('/api/google-fit/auth-url');\nconst data = await response.json();\nwindow.location.href = data.authUrl; // Redirect user\n```\n\n---\n\n### 2. OAuth Callback Handler\n\n**Endpoint**: `GET /api/google-fit/callback`\n\n**Purpose**: Handle the OAuth callback from Google (automatic)\n\n**URL Format**:\n```\nGET /api/google-fit/callback?code=AUTH_CODE&state=STATE\n```\n\n**Parameters**:\n- `code` (string) - Authorization code from Google\n- `state` (string) - Security state parameter\n- `userId` (string, optional) - User ID to associate tokens with\n- `error` (string, optional) - Error code if authorization failed\n\n**Response** (Success):\n- Redirects to `/dashboard?googleFitConnected=true&userId=USER_ID`\n\n**Response** (Error):\n- Redirects to `/dashboard?googleFitError=ERROR_MESSAGE`\n\n**What Happens Behind Scenes**:\n1. Receives authorization code from Google\n2. Exchanges code for access and refresh tokens\n3. Stores tokens securely in `/data/tokens/USER_ID_tokens.json`\n4. Redirects user back to dashboard\n\n---\n\n### 3. Check Authentication Status\n\n**Endpoint**: `GET /api/google-fit/check-auth/:userId`\n\n**Purpose**: Check if a user has valid Google Fit authentication\n\n**Parameters**:\n- `userId` (string, path) - User ID to check\n\n**Request**:\n```bash\ncurl http://localhost:5000/api/google-fit/check-auth/user-123\n```\n\n**Response** (Authenticated):\n```json\n{\n  \"success\": true,\n  \"authenticated\": true,\n  \"userId\": \"user-123\"\n}\n```\n\n**Response** (Not Authenticated):\n```json\n{\n  \"success\": true,\n  \"authenticated\": false,\n  \"userId\": \"user-123\"\n}\n```\n\n**Usage**:\n```javascript\nconst userId = currentUser.id;\nconst response = await fetch(`/api/google-fit/check-auth/${userId}`);\nconst data = await response.json();\n\nif (data.authenticated) {\n  console.log('User has Google Fit access!');\n  // Show sync button\n} else {\n  console.log('User needs to connect Google Fit');\n  // Show connect button\n}\n```\n\n---\n\n### 4. Sync Health Data from Google Fit\n\n**Endpoint**: `GET /api/google-fit/sync/:userId`\n\n**Purpose**: Fetch latest health data from Google Fit and sync to app\n\n**Parameters**:\n- `userId` (string, path) - User ID whose data to sync\n\n**Request**:\n```bash\ncurl http://localhost:5000/api/google-fit/sync/user-123\n```\n\n**Response** (Success):\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"walkingHours\": 1.5,\n    \"sleepHours\": 7.2,\n    \"steps\": 6000,\n    \"avgHeartRate\": 72,\n    \"source\": \"Google Fit\",\n    \"syncedAt\": \"2026-02-10T15:30:00Z\"\n  },\n  \"message\": \"Health data synced successfully from Google Fit\"\n}\n```\n\n**Response** (Not Authenticated):\n```json\n{\n  \"success\": false,\n  \"error\": \"User not authenticated with Google Fit\",\n  \"requiresAuth\": true,\n  \"statusCode\": 401\n}\n```\n\n**Response** (API Error):\n```json\n{\n  \"success\": false,\n  \"error\": \"Failed to sync health data from Google Fit\",\n  \"statusCode\": 500\n}\n```\n\n**What Gets Synced**:\n- **Walking Hours**: Calculated from step count (4000 steps = 1 hour)\n- **Sleep Hours**: Total sleep duration from sleep segments\n- **Steps**: Total step count from last 24 hours\n- **Heart Rate**: Average BPM from measurements\n\n**Data Storage**:\n- Updates `health_data.json` with latest metrics\n- Creates notification with sync status\n- Sets timestamp of sync\n\n**Usage**:\n```javascript\nconst userId = currentUser.id;\n\ntry {\n  const response = await fetch(`/api/google-fit/sync/${userId}`);\n  const data = await response.json();\n\n  if (data.success) {\n    console.log('Synced:', data.data);\n    // Update UI with new data\n    document.getElementById('walkingHours').textContent = data.data.walkingHours;\n    document.getElementById('sleepHours').textContent = data.data.sleepHours;\n  } else if (data.requiresAuth) {\n    console.log('Need to authenticate first');\n    // Show connect button\n  }\n} catch (error) {\n  console.error('Sync failed:', error);\n}\n```\n\n---\n\n### 5. Disconnect Google Fit\n\n**Endpoint**: `POST /api/google-fit/disconnect/:userId`\n\n**Purpose**: Revoke Google Fit access and delete stored tokens\n\n**Parameters**:\n- `userId` (string, path) - User ID to disconnect\n\n**Request**:\n```bash\ncurl -X POST http://localhost:5000/api/google-fit/disconnect/user-123\n```\n\n**Response** (Success):\n```json\n{\n  \"success\": true,\n  \"message\": \"Google Fit access revoked successfully\"\n}\n```\n\n**Response** (Not Connected):\n```json\n{\n  \"success\": false,\n  \"error\": \"User not connected to Google Fit\",\n  \"statusCode\": 400\n}\n```\n\n**What Happens**:\n1. Loads user's stored tokens\n2. Calls Google to revoke access\n3. Deletes token file from `/data/tokens/`\n4. User must reconnect to sync again\n\n**Usage**:\n```javascript\nconst userId = currentUser.id;\n\nif (confirm('Disconnect Google Fit?')) {\n  const response = await fetch(`/api/google-fit/disconnect/${userId}`, {\n    method: 'POST'\n  });\n  const data = await response.json();\n\n  if (data.success) {\n    console.log('Disconnected successfully');\n    // Hide sync button, show connect button\n  }\n}\n```\n\n---\n\n## Data Format\n\n### Health Data Object\n\n```json\n{\n  \"userId\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"walkingHours\": 1.5,\n  \"steps\": 6000,\n  \"sleepHours\": 7.2,\n  \"screenTimeHours\": 5,\n  \"waterIntakeGlasses\": 8,\n  \"avgHeartRate\": 72,\n  \"lastGoogleFitSync\": \"2026-02-10T15:30:00Z\",\n  \"syncSource\": \"Google Fit\",\n  \"timestamp\": \"2026-02-10T15:30:00Z\"\n}\n```\n\n### Token Object (Stored Securely)\n\n```json\n{\n  \"access_token\": \"ya29.a0AfH6SMBx...\",\n  \"expires_in\": 3599,\n  \"refresh_token\": \"1//0gV6Rz...\",\n  \"scope\": \"https://www.googleapis.com/auth/fitness.activity.read ...\",\n  \"token_type\": \"Bearer\",\n  \"id_token\": \"eyJhbGc...\"\n}\n```\n\n---\n\n## Error Handling\n\n### Common Errors\n\n| Error | Status | Cause | Solution |\n|-------|--------|-------|----------|\n| `invalid_grant` | 400 | Invalid credentials | Check `.env` file, restart server |\n| `redirect_uri_mismatch` | 400 | Wrong redirect URL | Update Google Cloud console |\n| `access_denied` | 401 | User denied permissions | Ask user to approve |\n| `User not authenticated` | 401 | No valid tokens | Call connect endpoint first |\n| `API quota exceeded` | 429 | Too many requests | Wait before retrying |\n| `Server error` | 500 | Backend issue | Check server logs |\n\n### Error Response Format\n\n```json\n{\n  \"success\": false,\n  \"error\": \"Error message description\",\n  \"requiresAuth\": false,\n  \"statusCode\": 500\n}\n```\n\n### Handling Errors in Frontend\n\n```javascript\ntry {\n  const response = await fetch(`/api/google-fit/sync/${userId}`);\n  const data = await response.json();\n\n  if (!response.ok) {\n    if (response.status === 401) {\n      // Need to authenticate\n      await connectGoogleFit();\n    } else if (response.status === 429) {\n      // Rate limited - wait and retry\n      setTimeout(() => syncGoogleFitData(userId), 5000);\n    } else {\n      // General error\n      console.error('Sync failed:', data.error);\n    }\n  }\n} catch (error) {\n  console.error('Network error:', error);\n}\n```\n\n---\n\n## Rate Limiting\n\n### Current Limits\n- **Sync endpoint**: No explicit limit (Google Fit API limits ~1000 requests/day)\n- **OAuth**: Standard Google OAuth limits\n\n### Best Practices\n- Don't sync more than once per 5 minutes\n- Implement exponential backoff for retries\n- Cache results for 10-15 minutes\n\n---\n\n## Security Considerations\n\n### Token Storage\n```\n/data/tokens/\n├── user-123_tokens.json    (Protected by file permissions)\n├── user-456_tokens.json\n└── ...\n```\n\n### Security Features\n✅ OAuth 2.0 - Industry standard\n✅ Access tokens with expiration\n✅ Refresh tokens for renewal\n✅ HTTPS ready (for production)\n✅ State parameter for CSRF protection\n✅ Tokens never exposed to frontend\n\n### Production Deployment\n\n```javascript\n// Before deploying:\n1. Use environment variables (not .env file)\n2. Enable HTTPS\n3. Encrypt tokens in database\n4. Add token encryption at rest\n5. Implement audit logging\n6. Add rate limiting\n7. Use secure session storage\n```\n\n---\n\n## Integration Examples\n\n### Full Sync Flow\n\n```javascript\n// 1. Check if authenticated\nconst authResponse = await fetch(`/api/google-fit/check-auth/${userId}`);\nconst authData = await authResponse.json();\n\nif (!authData.authenticated) {\n  // 2. Get auth URL\n  const urlResponse = await fetch('/api/google-fit/auth-url');\n  const urlData = await urlResponse.json();\n  // 3. Redirect to Google\n  window.location.href = urlData.authUrl;\n} else {\n  // 4. User is authenticated, sync data\n  const syncResponse = await fetch(`/api/google-fit/sync/${userId}`);\n  const syncData = await syncResponse.json();\n  \n  if (syncData.success) {\n    // 5. Update UI\n    updateDashboard(syncData.data);\n  }\n}\n```\n\n### Auto-Sync Implementation\n\n```javascript\n// Sync every 30 minutes\nsetInterval(() => {\n  syncGoogleFitData(currentUser.id)\n    .then(() => console.log('Auto-sync complete'))\n    .catch(err => console.error('Auto-sync failed:', err));\n}, 30 * 60 * 1000);\n\n// Sync on app focus\nwindow.addEventListener('focus', () => {\n  syncGoogleFitData(currentUser.id);\n});\n```\n\n---\n\n## Testing\n\n### Test Cases\n\n```javascript\n// 1. Test get auth URL\nGET /api/google-fit/auth-url\nExpect: 200, success=true, authUrl contains \"accounts.google.com\"\n\n// 2. Test check auth (not authenticated)\nGET /api/google-fit/check-auth/user-123\nExpect: 200, authenticated=false\n\n// 3. Test sync without auth\nGET /api/google-fit/sync/user-123\nExpect: 401, requiresAuth=true\n\n// 4. Test disconnect without connection\nPOST /api/google-fit/disconnect/user-123\nExpect: 400, error about no connection\n```\n\n### cURL Examples\n\n```bash\n# Get auth URL\ncurl http://localhost:5000/api/google-fit/auth-url | jq\n\n# Check auth status\ncurl http://localhost:5000/api/google-fit/check-auth/user-123 | jq\n\n# Try sync (will fail if not authenticated)\ncurl http://localhost:5000/api/google-fit/sync/user-123 | jq\n\n# Disconnect\ncurl -X POST http://localhost:5000/api/google-fit/disconnect/user-123 | jq\n```\n\n---\n\n## Support\n\n### Documentation\n- [Google Fit REST API](https://developers.google.com/fit/rest)\n- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)\n- [googleapis npm package](https://www.npmjs.com/package/googleapis)\n\n### Debugging\n\n**Enable debug logging**:\n```javascript\n// Add to your code\nconsole.log('Google Fit Debug:', {\n  userId: currentUser.id,\n  hasToken: googleFitService.hasValidToken(currentUser.id),\n  tokenFile: `/data/tokens/${currentUser.id}_tokens.json`\n});\n```\n\n**Check token file**:\n```bash\ncat /data/tokens/user-123_tokens.json\n```\n\n---\n\n**Last Updated**: February 10, 2026\n